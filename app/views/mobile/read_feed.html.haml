- content_for :title do
  = @subscription.feed.title
  \- Fastladder Mobile

- content_for :head do
  %link{href: "https://unpkg.com/sakura.css/css/sakura.css", media: "screen", rel: "stylesheet"}
  %meta{name: "viewport", content: "width=device-width, initial-scale=1.0"}

%h1
  %a{href: '/mobile'}
    %img(src="/img/logo_small.gif" alt="Fastladder")
%h2 #{@subscription.feed.title}
-@items.each do |item|
  %div.item{id: "item-#{item.id}"}
    %h3 
      %a.read{href: item.link, target: "_blank"}=item.title

    %div!= remove_style_attr_of_all_tags(item.body)
    %div
      %p.smallgrey
        = button_to "Pin", "/mobile/#{item.id}/pin", class: "pin", method: :post, form: { data: { turbo: false } }
        Created: #{item.created_on.localtime}
    %hr

%div
  = button_to "Mark as read", "/mobile/#{@subscription.id}/read?timestamp=#{@items.last.updated_on.to_i}", id: "next", style: "font-size: 1.5em;", method: :post, form: { data: { turbo: false } }

%div(style="height:2000px")
:css
  .smallgrey {
    font-size: 0.8em;
    color: #666;
  }

:javascript
  var current = "item-#{params[:item_id]}";

  // Submission guard
  const isFormSubmitted = (form) => form.dataset.submitted === 'true';
  const markAsSubmitted = (form) => form.dataset.submitted = 'true';

  const scroll = (id)=>{
    document.querySelectorAll('.item').forEach((e)=> e.style.backgroundColor = '#f9f9f9');
    const dom = document.getElementById(current)
    dom.scrollIntoView();
    dom.style.backgroundColor = "#ffffcc";
  }

  if(location.hash) {
    current = location.hash.replace('#', '');
    scroll(current);
  }
  var ids = Array.from(document.querySelectorAll('.item')).map((e)=> e.id);

  window.addEventListener('keydown', (e) => {
    if (e.key === 'j') {
      var next = ids[ids.indexOf(current) + 1];
      if(next) current = next;
      scroll(current);
    }
    if (e.key === 'k') {
      var prev = ids[ids.indexOf(current) - 1];
      if(prev) current = prev;
      scroll(current);
    }
  });

  window.addEventListener('keyup', (e)=> {
    // pin
    if(e.key === 'p') {
      const form = document.getElementById(current).querySelector('form.button_to');
      if(form && !isFormSubmitted(form)) {
        markAsSubmitted(form);
        form.querySelector('button').click();
      }
    }

    // read
    if(e.key === 'v') {
      const link = document.getElementById(current).querySelector('a.read');
      if(link) link.click();
    }

    // next
    if(e.key === 's') {
      const button = document.getElementById('next');
      if(button && !isFormSubmitted(button.closest('form'))) {
        markAsSubmitted(button.closest('form'));
        button.click();
      }
    }
  });

